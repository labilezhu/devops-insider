> https://dzone.com/articles/lightweight-jvm-diagnostics-tools-and-containers

JVM Diagnostic Mechanisms
-------------------------

This is by no means a complete survey, but it's worth just listing quickly the main JVM diagnostic mechanisms and how they work before we can consider what happens in a containerized environment. (For more on this, including source links, check out [Serviceability in Hotspot](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html) from the OpenJDK documentation.)

-   **JVM performance data**: By default, the JVM emits binary data into a file in the temp directory called **hsperfdata_$UID/$PID**. This file contains statistics on garbage collection, class loading, JIT compilation, and other events. It is the data source for **jstat** and is also how **jps** and **jinfo** discover information about running JVM processes.
-   **JVM attach interface**: By default, the JVM will react to a QUIT signal by looking for a file in the working directory called **.attach_pid\$PID**. If the file exists, it will create a UNIX domain socket in the temp directory called **.java_pid$PID** and create a thread that will listen for commands on that socket. **jmap**, **jstack**, and **jcmd** are some of the tools that rely on the attach interface for heap dumps, thread dumps, obtaining VM information, and other facilities.
-   **Serviceability Agent**: A component that runs in an external process and reads JVM data structures from the target by using **ptrace** (for a live process) or ELF parsing (for a core dump). This allows live diagnostics and core dump analysis to see thread states, heap objects, call stacks, and so on. **HSDB**, **SOSQL**, and other tools rely on the Serviceability Agent API. Notably, the JDK version has to match exactly between the original JVM and the one used to analyze the core dump or live process.
-   **JVMTI**: This tool interface allows an external agent library (.so) to be loaded with or attached to a JVM process and register for various interesting events, including class loading, thread start, garbage collection, monitor contention, and others. To load an agent with your process, you use the **-agentpath** command-line argument. To attach an agent to a live process, you use the JVM attach interface.
-   **JMX**: The JDK runtime provides a basic set of managed beans for inspecting the GC heap, threads, and other components. Many additional managed beans exist in various application containers like Tomcat.

Running Diagnostic Tools From the Container
-------------------------------------------

Although I don't particularly like the idea of bloating your container image with diagnostic tools, suppose you've done it anyway. Here are some of the likely problems:

-   The Serviceability Agent API uses the **ptrace** syscall, which is disabled in Docker's seccomp profile (and I imagine it would be disabled by other sensible container runtimes as well). You can use a [custom seccomp profile](https://docs.docker.com/engine/security/seccomp/), of course, if you understand the security consequences for your host.
-   Using perf and perf-based tools inside the container requires the **perf_event_open** syscall, which is again blocked by Docker's default seccomp profile.


> http://openjdk.java.net/groups/hotspot/docs/Serviceability.html

| Technology  | Source Location  | Usage in the J2SE Repository |
| --- |  --- |  --- |
| [JVM TI- Java Virtual Machine Tools Interface](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bjvmti) | [hotspot/src/share/vm/prims/jvmtiGen.java](http://opengrok.neojava.org/hotspot/xref/src/share/vm/prims/jvmtiGen.java)[hotspot/src/share/vm/prims/jvmtiGen.java](http://opengrok.neojava.org/hotspot/xref/src/share/vm/prims/jvmtiEnvFill.java)[hotspot/src/share/vm/prims/jvmti.xml](http://opengrok.neojava.org/hotspot/xref/src/share/vm/prims/jvmti.xml)[hotspot/src/share/vm/prims/jvmti*](http://opengrok.neojava.org/hotspot/xref/src/share/vm/prims)build/.../generated/jvmtifiles/jvmtiEnter.cppbuild/.../generated/jvmtifiles/jvmtiEnterTrace.cppbuild/.../generated/jvmtifiles/jvmtiEnv.hppbuild/.../generated/jvmtifiles/jvmtiEnvRecommended.cppbuild/.../generated/jvmtifiles/jvmtiEnvStub.cppbuild/.../generated/jvmtifiles/jvmti.h    (copied to j2se/src/share/javavm/export/jvmti.h) | [J2SE Info](http://openjdk.java.net/groups/serviceability/svcjdk.html#tJDWP)[Bugs](http://bugs.sun.com/bugdatabase/search.do?process=1&category=hotspot&bugStatus=open&subcategory=jvmti) |
| [Monitoring and Management](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bmanagement) | [hotspot/src/share/vm/services/](http://opengrok.neojava.org/hotspot/xref/src/share/vm/services/) (most but not all) | [J2SE Info](http://openjdk.java.net/groups/serviceability/svcjdk.html#tmanagement)[Bugs](http://bugs.sun.com/bugdatabase/search.do?process=1&category=hotspot&bugStatus=open&subcategory=monitoring_management) |
| [Dynamic attach mechanism](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#battach) | [src/share/vm/services/attachListener.*](http://opengrok.neojava.org/hotspot/xref/src/share/vm/services/)[src/os/linux/vm/attachListener_linux.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/linux/vm/attachListener_linux.cpp)[src/os/solaris/vm/attachListener_solaris.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/solaris/vm/attachListener_solaris.cpp)[src/os/win32/vm/attachListener_win32.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/win32/vm/attachListener_win32.cpp) | [J2SE Info](http://openjdk.java.net/groups/serviceability/svcjdk.html#tattach) |
| [Jvmstat Performance Counters](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bjvmstat) | [src/share/vm/prims/perf.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/prims/perf.cpp)[src/share/runtime/perfMemory.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/runtime/perfMemory.cpp)[src/share/runtime/perfData.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/runtime/perfData.cpp)[src/share/runtime/statSampler.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/runtime/statSampler.cpp)[src/share/vm/services/*Service.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/services/)[src/os/solaris/vm/perfMemory_solaris.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/solaris/vm/perfMemory_solaris.cpp)[src/os/linux/vm/perfMemory_linux.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/linux/vm/perfMemory_linux.cpp)[src/os/win32/vm/perfMemory_win32.cpp](http://opengrok.neojava.org/hotspot/xref/src/os/win32/vm/perfMemory_win32.cpp) | [J2SE Info](http://openjdk.java.net/groups/serviceability/svcjdk.html#tjvmstat)[Bugs](http://bugs.sun.com/bugdatabase/search.do?process=1&category=hotspot&bugStatus=open&subcategory=perfdata) |
| [Serviceability Agent](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bsa) | [hotspot/agent/](http://opengrok.neojava.org/hotspot/xref/agent/)[hotspot/src/share/vm/runtime/vmStructs.hpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/runtime/vmStructs.hpp/)[hotspot/src/share/vm/runtime/vmStructs.cpp](http://opengrok.neojava.org/hotspot/xref/src/share/vm/runtime/vmStructs.cpp/)hotspot/cpu/*cpu*/vm/vmstructs_*cpu*.hpphotspot/os_cpu/*os-cpu*/vm/vmstructs_*os-cpu*.hpp | [J2SE Info](http://openjdk.java.net/groups/serviceability/svcjdk.html#tsa)[Usenix Serviceability Agent paper](http://www.usenix.org/events/jvm01/full_papers/russell/russell_html/index.html) |
| [DTrace Support (Solaris only)](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bdtrace) | [hotspot/src/os/solaris/dtrace/](http://opengrok.neojava.org/hotspot/xref/src/os/solaris/dtrace/)[hotspot/build/solaris/makefiles/dtrace.make](http://opengrok.neojava.org/hotspot/xref/build/solaris/makefiles/dtrace.make) | [DTrace Probes in HotSpot](http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html)[User Guide](http://docs.sun.com/app/docs/doc/819-5488) |
| [pstack Support(Solaris only)](http://openjdk.java.net/groups/hotspot/docs/Serviceability.html#bpstack) | [hotspot/src/os/solaris/dtrace/](http://opengrok.neojava.org/hotspot/xref/src/os/solaris/dtrace/) | [User Guide](http://docs.sun.com/app/docs/doc/816-5165/6mbb0m9pm?a=view) |


> http://openjdk.java.net/groups/serviceability/svcjdk.html
